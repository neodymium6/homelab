---
- name: Ensure Grafana directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ grafana_dir }}"
    - "{{ grafana_config_dir }}"
  become: true

- name: Ensure Grafana data directory exists with correct ownership
  ansible.builtin.file:
    path: "{{ grafana_data_dir }}"
    state: directory
    owner: "472"
    group: "472"
    mode: "0755"
  become: true

- name: Ensure Grafana provisioning directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ grafana_config_dir }}/provisioning"
    - "{{ grafana_config_dir }}/provisioning/datasources"
    - "{{ grafana_config_dir }}/provisioning/dashboards"
    - "{{ grafana_config_dir }}/dashboards"
  become: true

- name: Ensure docker monitoring network exists
  community.docker.docker_network:
    name: monitoring
    ipam_config:
      - subnet: "{{ docker.networks.monitoring.subnet }}"
  become: true

- name: Deploy Grafana datasource provisioning
  ansible.builtin.template:
    src: provisioning/datasources/prometheus.yml.j2
    dest: "{{ grafana_config_dir }}/provisioning/datasources/prometheus.yml"
    mode: "0644"
  notify: Restart grafana
  become: true

- name: Deploy Grafana dashboards provider provisioning
  ansible.builtin.template:
    src: provisioning/dashboards/dashboards.yml.j2
    dest: "{{ grafana_config_dir }}/provisioning/dashboards/dashboards.yml"
    mode: "0644"
  notify: Restart grafana
  become: true

- name: Deploy Grafana dashboard JSON files
  ansible.builtin.copy:
    src: "dashboards/{{ item }}"
    dest: "{{ grafana_config_dir }}/dashboards/{{ item }}"
    mode: "0644"
  loop:
    - node-exporter-full.json
    - proxmox-nodes.json
  notify: Restart grafana
  become: true

- name: Deploy Grafana docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ grafana_compose_path }}"
    mode: "0644"
  notify: Restart grafana
  become: true

- name: Start Grafana via docker compose
  ansible.builtin.command:
    argv:
      - docker
      - compose
      - -f
      - "{{ grafana_compose_path }}"
      - up
      - -d
  become: true

- name: Allow proxy-01 to reach Grafana backend port
  community.general.ufw:
    rule: allow
    proto: tcp
    src: "{{ grafana_proxy_ip }}"
    port: "{{ grafana_port | string }}"
  when:
    - grafana_enable_ufw | bool
    - grafana_allow_from_proxy_only | bool
  become: true
