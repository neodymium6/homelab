http:
  routers:
{% for s in services | default([]) %}
{%   if s.proxy is defined and s.proxy.enable | default(false) %}
{%     set host_rules = [] %}
{%     set _ = host_rules.append("Host(`" ~ s.name ~ "-proxy." ~ network.domain ~ "`)") %}
{%     if s.proxy.public_hostnames is defined and s.proxy.public_hostnames | length > 0 %}
{%       for hostname in s.proxy.public_hostnames %}
{%         set _ = host_rules.append("Host(`" ~ hostname ~ "`)") %}
{%       endfor %}
{%     elif s.proxy.hostnames is defined and s.proxy.hostnames | length > 0 %}
{%       for hostname in s.proxy.hostnames %}
{%         set _ = host_rules.append("Host(`" ~ hostname ~ "`)") %}
{%       endfor %}
{%     endif %}
{%     set router_rule = "(" ~ (host_rules | join(' || ')) ~ ")" %}
{%     if s.proxy.methods is defined and s.proxy.methods | length > 0 %}
{%       set method_rules = [] %}
{%       for method in s.proxy.methods %}
{%         set _ = method_rules.append("Method(`" ~ (method | upper) ~ "`)") %}
{%       endfor %}
{%       set router_rule = router_rule ~ " && (" ~ (method_rules | join(' || ')) ~ ")" %}
{%     endif %}
    {{ s.name }}:
{%     if s.proxy.service is defined and s.proxy.service == 'api@internal' %}
      rule: "{{ router_rule }} && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      entryPoints: ["websecure", "tunnel"]
      service: "api@internal"
{%     else %}
      rule: "{{ router_rule }}"
      entryPoints: ["websecure", "tunnel"]
      service: {{ s.name }}-svc
{%     endif %}
{%     set mw = [] %}
{%     if s.proxy.allow_cidrs is defined and s.proxy.allow_cidrs | length > 0 %}
{%       set _ = mw.append(s.name ~ '-allow') %}
{%     endif %}
{%     if s.proxy.auth is defined and s.proxy.auth.users is defined and s.proxy.auth.users | length > 0 %}
{%       set _ = mw.append(s.name ~ '-auth') %}
{%     endif %}
{%     if s.proxy.retry is defined %}
{%       set _ = mw.append(s.name ~ '-retry') %}
{%     endif %}
{%     if mw | length > 0 %}
      middlewares:
{%       for m in mw %}
        - "{{ m }}"
{%       endfor %}
{%     endif %}
{%   endif %}
{% endfor %}

{% set ns = namespace(any_service=false) %}
{% for s in services | default([]) %}
{%   if s.proxy is defined and s.proxy.enable | default(false) and (s.proxy.service is not defined or s.proxy.service != 'api@internal') %}
{%     set ns.any_service = true %}
{%   endif %}
{% endfor %}
{% if ns.any_service %}
  services:
{% for s in services | default([]) %}
{%   if s.proxy is defined and s.proxy.enable | default(false) and (s.proxy.service is not defined or s.proxy.service != 'api@internal') %}
{%     set service_backend_host = (s.proxy.backend_host | default(s.name ~ '.' ~ network.domain)) %}
    {{ s.name }}-svc:
      loadBalancer:
{%     if s.proxy.insecure_skip_verify | default(false) %}
        serversTransport: "insecureSkipVerify"
{%     endif %}
{%     if s.proxy.healthcheck is defined %}
        healthCheck:
          path: "{{ s.proxy.healthcheck.path | default('/') }}"
{%       if s.proxy.healthcheck.interval is defined %}
          interval: "{{ s.proxy.healthcheck.interval }}"
{%       endif %}
{%       if s.proxy.healthcheck.timeout is defined %}
          timeout: "{{ s.proxy.healthcheck.timeout }}"
{%       endif %}
{%     endif %}
        servers:
{%       if s.proxy.backends is defined and s.proxy.backends | length > 0 %}
{%         for backend in s.proxy.backends %}
{%           set backend_host = (backend.host | default(service_backend_host)) %}
          - url: "{{ s.proxy.scheme | default('http') }}://{{ backend_host }}:{{ backend.port }}"
{%         endfor %}
{%       elif s.proxy.backend_url is defined %}
          - url: "{{ s.proxy.backend_url }}"
{%       else %}
          - url: "{{ s.proxy.scheme | default('http') }}://{{ service_backend_host }}:{{ s.proxy.port }}"
{%       endif %}
{%   endif %}
{% endfor %}
{% endif %}

{% set ns = namespace(any_mw=false) %}
{% for s in services | default([]) %}
{%   if s.proxy is defined and s.proxy.enable | default(false) %}
{%     if (s.proxy.allow_cidrs is defined and s.proxy.allow_cidrs | length > 0) or (s.proxy.auth is defined and s.proxy.auth.users is defined and s.proxy.auth.users | length > 0) or (s.proxy.retry is defined) %}
{%       set ns.any_mw = true %}
{%     endif %}
{%   endif %}
{% endfor %}
{% if ns.any_mw %}
  middlewares:
{% for s in services | default([]) %}
{%   if s.proxy is defined and s.proxy.enable | default(false) %}
{%     if s.proxy.allow_cidrs is defined and s.proxy.allow_cidrs | length > 0 %}
    {{ s.name }}-allow:
      ipWhiteList:
        sourceRange:
{%       for cidr in s.proxy.allow_cidrs %}
          - "{{ cidr }}"
{%       endfor %}
{%     endif %}
{%     if s.proxy.auth is defined and s.proxy.auth.users is defined and s.proxy.auth.users | length > 0 %}
    {{ s.name }}-auth:
      basicAuth:
        users:
{%       for user in s.proxy.auth.users %}
          - "{{ user }}"
{%       endfor %}
{%     endif %}
{%     if s.proxy.retry is defined %}
    {{ s.name }}-retry:
      retry:
        attempts: {{ s.proxy.retry.attempts | default(2) }}
{%       if s.proxy.retry.initial_interval is defined %}
        initialInterval: "{{ s.proxy.retry.initial_interval }}"
{%       endif %}
{%     endif %}
{%   endif %}
{% endfor %}
{% endif %}

{% set ns = namespace(any_transport=false) %}
{% for s in services | default([]) %}
{%   if s.proxy is defined and s.proxy.enable | default(false) and (s.proxy.service is not defined or s.proxy.service != 'api@internal') %}
{%     if s.proxy.insecure_skip_verify | default(false) %}
{%       set ns.any_transport = true %}
{%     endif %}
{%   endif %}
{% endfor %}
{% if ns.any_transport %}
  serversTransports:
    insecureSkipVerify:
      insecureSkipVerify: true
{% endif %}
