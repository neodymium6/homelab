---
- name: Ensure personal-site directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ personal_site_dir }}"
  become: true

- name: Ensure curl is installed for personal-site readiness checks
  ansible.builtin.apt:
    name: curl
    state: present
    update_cache: yes
  become: true

- name: Deploy personal-site docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ personal_site_compose_path }}"
    mode: "0644"
  notify: Restart personal_site
  become: true

- name: Start personal-site via docker compose
  ansible.builtin.command:
    argv:
      - docker
      - compose
      - -f
      - "{{ personal_site_compose_path }}"
      - up
      - -d
  become: true

- name: Deploy systemd unit for personal-site updates
  ansible.builtin.template:
    src: personal-site-update.service.j2
    dest: /etc/systemd/system/personal-site-update.service
    owner: root
    group: root
    mode: "0644"
  when: personal_site_update_enable | bool
  become: true

- name: Deploy systemd timer for personal-site updates
  ansible.builtin.template:
    src: personal-site-update.timer.j2
    dest: /etc/systemd/system/personal-site-update.timer
    owner: root
    group: root
    mode: "0644"
  when: personal_site_update_enable | bool
  become: true

- name: Reload systemd
  ansible.builtin.systemd:
    daemon_reload: true
  when: personal_site_update_enable | bool
  become: true

- name: Enable and start personal-site update timer
  ansible.builtin.systemd:
    name: personal-site-update.timer
    enabled: true
    state: started
  when: personal_site_update_enable | bool
  become: true

- name: Check whether personal-site update timer unit exists
  ansible.builtin.stat:
    path: /etc/systemd/system/personal-site-update.timer
  register: personal_site_update_timer_unit
  when: not (personal_site_update_enable | bool)
  become: true

- name: Stop and disable personal-site update timer
  ansible.builtin.systemd:
    name: personal-site-update.timer
    enabled: false
    state: stopped
  when:
    - not (personal_site_update_enable | bool)
    - personal_site_update_timer_unit.stat.exists
  become: true

- name: Remove personal-site update timer unit file
  ansible.builtin.file:
    path: /etc/systemd/system/personal-site-update.timer
    state: absent
  when: not (personal_site_update_enable | bool)
  become: true

- name: Remove personal-site update service unit file
  ansible.builtin.file:
    path: /etc/systemd/system/personal-site-update.service
    state: absent
  when: not (personal_site_update_enable | bool)
  become: true

- name: Reload systemd after removing personal-site update units
  ansible.builtin.systemd:
    daemon_reload: true
  when: not (personal_site_update_enable | bool)
  become: true

- name: Allow proxy-01 to reach personal-site backend ports
  loop: "{{ personal_site_backend_ports }}"
  loop_control:
    loop_var: personal_site_backend_port
  community.general.ufw:
    rule: allow
    proto: tcp
    src: "{{ personal_site_proxy_ip }}"
    port: "{{ personal_site_backend_port | string }}"
  when:
    - personal_site_enable_ufw | bool
    - personal_site_allow_from_proxy_only | bool
    - personal_site_proxy_ip is defined
  become: true
