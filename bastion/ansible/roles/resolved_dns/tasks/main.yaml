---
- name: Ensure systemd-resolved drop-in directory exists
  ansible.builtin.file:
    path: "{{ resolved_dropin_path | dirname }}"
    state: directory
    mode: "0755"
  become: true

- name: Configure systemd-resolved DNS for homelab
  ansible.builtin.template:
    src: 10-homelab-dns.conf.j2
    dest: "{{ resolved_dropin_path }}"
    mode: "0644"
  notify: Restart systemd-resolved
  become: true

- name: Check /etc/resolv.conf link status
  ansible.builtin.stat:
    path: "{{ resolved_resolv_conf_path }}"
    follow: false
  register: resolved_resolv_conf_stat
  become: true

- name: Ensure /etc/resolv.conf points to systemd-resolved
  ansible.builtin.file:
    src: "{{ resolved_resolv_conf_target }}"
    dest: "{{ resolved_resolv_conf_path }}"
    state: link
    force: true
  when: >
    (not resolved_resolv_conf_stat.stat.islnk | default(false)) or
    (resolved_resolv_conf_stat.stat.lnk_source | default('') != resolved_resolv_conf_target)
  become: true
