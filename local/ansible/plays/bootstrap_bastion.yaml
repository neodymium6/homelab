---
- name: Bootstrap bastion as Terraform/Ansible controller
  hosts: bastion
  become: true
  gather_facts: true

  vars_files:
    - ../../../cluster.yaml

  vars:
    checkout_dir: "/home/{{ login_user }}/homelab"
    ansible_venv_dir: "/home/{{ login_user }}/.venv/ansible"

  tasks:
    - name: Install base packages (Python, git, unzip, venv)
      ansible.builtin.apt:
        name:
          - python3
          - python3-venv
          - python3-pip
          - git
          - unzip
        state: present
        update_cache: yes

    - name: Create Ansible virtualenv on bastion
      become: false
      ansible.builtin.command:
        cmd: "python3 -m venv {{ ansible_venv_dir }}"
      args:
        creates: "{{ ansible_venv_dir }}/bin/activate"

    - name: Upgrade pip inside Ansible venv
      become: false
      ansible.builtin.pip:
        name: pip
        state: latest
        executable: "{{ ansible_venv_dir }}/bin/pip"

    - name: Install Ansible into venv
      become: false
      ansible.builtin.pip:
        name: ansible
        executable: "{{ ansible_venv_dir }}/bin/pip"

    - name: Add alias for ansible-playbook in venv
      become: false
      ansible.builtin.lineinfile:
        path: "/home/{{ login_user }}/.bashrc"
        insertafter: EOF
        line: 'alias ansible-playbook="$HOME/.venv/ansible/bin/ansible-playbook"'

    - name: Add alias for ansible-galaxy in venv
      become: false
      ansible.builtin.lineinfile:
        path: "/home/{{ login_user }}/.bashrc"
        insertafter: EOF
        line: 'alias ansible-galaxy="$HOME/.venv/ansible/bin/ansible-galaxy"'

    - name: Download Terraform
      become: false
      ansible.builtin.get_url:
        url: "https://releases.hashicorp.com/terraform/1.8.5/terraform_1.8.5_linux_amd64.zip"
        dest: "/home/{{ login_user }}/terraform.zip"
        mode: "0644"

    - name: Ensure ~/.local/bin exists on bastion
      become: false
      ansible.builtin.file:
        path: "/home/{{ login_user }}/.local/bin"
        state: directory
        mode: "0755"

    - name: Unzip Terraform binary
      become: false
      ansible.builtin.unarchive:
        src: "/home/{{ login_user }}/terraform.zip"
        dest: "/home/{{ login_user }}/.local/bin"
        remote_src: true
        mode: "0755"

    - name: Ensure ~/.local/bin in PATH (bash)
      become: false
      ansible.builtin.lineinfile:
        path: "/home/{{ login_user }}/.bashrc"
        regexp: '(^export PATH=.*\.local/bin.*$)'
        line: 'export PATH="$HOME/.local/bin:$PATH"'
        insertafter: EOF

    - name: Clone homelab repo to bastion
      become: false
      ansible.builtin.git:
        repo: "https://github.com/neodymium6/homelab.git"
        dest: "{{ checkout_dir }}"
        version: main
        update: yes

    - name: Copy cluster.yaml to bastion (not in git)
      become: false
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../../cluster.yaml"
        dest: "{{ checkout_dir }}/cluster.yaml"
        owner: "{{ login_user }}"
        group: "{{ login_user }}"
        mode: "0644"

    - name: Copy bastion terraform.tfvars to bastion (not in git)
      become: false
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../../bastion/terraform/terraform.tfvars"
        dest: "{{ checkout_dir }}/bastion/terraform/terraform.tfvars"
        owner: "{{ login_user }}"
        group: "{{ login_user }}"
        mode: "0600"

